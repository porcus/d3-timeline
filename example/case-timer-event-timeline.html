<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Case Timer Event Timeline</title>

    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">     -->
    <!-- <link rel="stylesheet" href="https://rawgithub.com/Caged/d3-tip/master/examples/example-styles.css" /> -->
    <link rel="stylesheet" href="../dist/timeline-chart.css" />
    <link rel="stylesheet" href="../dist/case-timer-event-viewer.css" />
    <link rel="stylesheet" href="popper.css" />

    <!-- Until this issue (https://github.com/filamentgroup/tablesaw/issues/342) is fixed, we will load tablesaw at this point instead of inside case-timer-event-viewer.js -->
    <script src="https://cdn.jsdelivr.net/npm/tablesaw@3.0.9/dist/tablesaw.min.js"></script>

    <script data-require="d3@4.0.0" data-semver="4.0.0" src="https://d3js.org/d3.v4.min.js"></script>

    <script src="../dist/timeline-chart.js"></script>
    <script src="../dist/case-timer-event-viewer.js"></script>
    <!-- <script src="tablesaw.js"></script> -->

    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/5.13.3/jsoneditor.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/5.13.3/jsoneditor-minimalist.js"></script> -->

    <!-- <script src="https://cdn.jsdelivr.net/npm/tablesaw@3.0.9/dist/tablesaw.min.js"></script> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/titatoggle/2.1.2/titatoggle-dist-min.css" integrity="sha256-MSuL2HDBiBhNtoZ7N4IemvaGhTuEcanpxDHuQY+ju0Y=" crossorigin="anonymous" /> -->
</head>

<body>

    <button data-filename="case-timer-event-data-1.json">Load Case Data 1</button>
    <button data-filename="case-timer-event-data-2.json">Load Case Data 2</button>
    <button data-filename="case-timer-event-data-3.json">Load Case Data 3</button>
    <button data-filename="case-timer-event-data-4.json">Load Case Data 4</button>
    <button data-filename="case-timer-event-data-5.json">Load Case Data 5 (owner changed)</button>
    <button data-filename="case-timer-event-data-6.json">Load Case Data 6 (4 timers)</button>
    <button data-filename="case-timer-event-data-7.json">Load Case Data 7 (no timers)</button>
    <button data-filename="case-timer-event-data-8.json">Load Case Data 8 (2 concurrent snapshots)</button>
    <button data-filename="case-timer-event-data-9.json">Load Case Data 9 (no employee primary site)</button>
    <button data-filename="case-timer-event-data-10.json">Load Case Data 10 (Repeated error in CEGCRFSCRFC)</button>
    <button data-filename="case-timer-event-data-11.json">Load Case Data 11 (for Support case 17353)</button>
    <button data-filename="case-timer-event-data-12.json">Load Case Data 12 (mis-ordered concurrent timer events)</button>
    <button data-filename="case-timer-event-data-13.json">Load Case Data 13 (new SS format)</button>

    <div id='body-content'></div>

    <script id="code">
        var browser = null;
        (function initializePrototypeTimeline() {
            browser = new CaseTimerEventViewer(document.getElementById('body-content'), null);

            d3.selectAll('button[data-filename]').nodes().forEach((el,i) => { 
                var btn = d3.select(el);
                btn.on('click', _ => { d3.json(btn.attr('data-filename'), data => browser.updateTimelineData(data) ) });
            });
        })();
    </script>

    <script>
        const timelineData = [
            {
                label: 'SLA Case Timer Events',
                data: [    // Created wed, mar 8
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [
                            'Event: SLA added to case.',
                            '  Respect Working Hours: true',
                            '  Respect Calendars: true',
                            '  Target Resolution Time: 12 hours',
                            '  Site: Phoenix, AZ',
                            '  Owner: Colonel Mustard'
                        ].join("<br>"),
                        at: new Date(2017, 2, 8, 11, 15)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Initial response reminder message sent to owner.",
                            "  Owner: Colonel Mustard",
                            "  SLA Elapsed Time: 2 hours"
                        ].join("<br>"),
                        at: new Date(2017, 2, 8, 13, 15)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Case owner sent email to employee.", 
                            "  Owner: Colonel Mustard",
                            "Event: SLA clock paused.",
                            "  SLA Elapsed Time: 2 hours 15 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 8, 13, 30),
                    },
                    {
                        label: 'SLA Clock Paused',
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-white',
                        from: new Date(2017, 2, 8, 13, 30),
                        to: new Date(2017, 2, 8, 15, 0)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Customer responded to case via email.", 
                            "Event: SLA clock started.",
                            "  SLA Elapsed Time: 2 hours 15 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 8, 15, 0)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Case owner sent email to employee.", 
                            "  Owner: Colonel Mustard",
                            "Event: SLA clock paused.",
                            "  SLA Elapsed Time: 3 hours 45 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 8, 16, 30)
                    },
                    {
                        label: 'SLA Clock Paused',
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-white',
                        from: new Date(2017, 2, 8, 16, 30),
                        to: new Date(2017, 2, 9, 8, 30)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Customer responded to case via email.", 
                            "Event: SLA clock started.",
                            "  SLA Elapsed Time: 3 hours 45 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 9, 8, 30)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Case owner sent email to employee.", 
                            "  Owner: Colonel Mustard",
                            "Event: SLA clock paused.",
                            "  SLA Elapsed Time: 4 hours 30 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 9, 9, 45),
                    },
                    {
                        label: 'SLA Clock Paused',
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-white',
                        from: new Date(2017, 2, 9, 9, 45),
                        to: new Date(2017, 2, 9, 12, 0)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Customer responded to case via email.", 
                            "Event: SLA clock started.",
                            "  SLA Elapsed Time: 4 hours 30 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 9, 12, 0)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [
                            "Event: Case assigned to new owner.",
                            "  Former owner: Colonel Mustard",
                            "  New owner: Miss Scarlet",
                            " Site of case owner has also changed.",
                            "  Former site: Phoenix, AZ",
                            "  New site: Houston, TX",
                            "SLA Elapsed Time: 4 hours 45 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 9, 12, 15)
                    },

                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Case owner sent email to employee.", 
                            "  Owner: Miss Scarlet",
                            "Event: SLA clock paused.",
                            "  SLA Elapsed Time: 5 hours 15 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 9, 12, 45)
                    },
                    {
                        label: 'SLA Clock Paused',
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-white',
                        from: new Date(2017, 2, 9, 12, 45),
                        to: new Date(2017, 2, 10, 7, 0)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Customer responded to case via email.", 
                            "Event: SLA clock started.",
                            "  SLA Elapsed Time: 5 hours 15 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 10, 7, 0)
                    },

                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Control point breached.", 
                            "  Condition: 50% of target resolution time.",
                            "  Action: Set SLA Color to Yellow.",
                            "Event: SLA clock started.",
                            "  SLA Elapsed Time: 6 hours"
                        ].join("<br>"),
                        at: new Date(2017, 2, 10, 8, 45)
                    },


                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Case owner sent email to employee.", 
                            "  Owner: Miss Scarlet",
                            "Event: SLA clock paused.",
                            "  SLA Elapsed Time: 7 hours"
                        ].join("<br>"),
                        at: new Date(2017, 2, 10, 9, 45)
                    },
                    {
                        label: 'SLA Clock Paused',
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-white',
                        from: new Date(2017, 2, 10, 9, 45),
                        to: new Date(2017, 2, 10, 13, 30)
                    },
                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Customer responded to case via email.", 
                            "Event: SLA clock started.",
                            "  SLA Elapsed Time: 7 hours"
                        ].join("<br>"),
                        at: new Date(2017, 2, 10, 13, 30)
                    },

                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Control point breached.", 
                            "  Condition: 75% of target resolution time.",
                            "  Action: Set SLA Color to Orange.",
                            "Event: Control point breached.", 
                            "  Condition: 75% of target resolution time.",
                            "  Action: Notify Manager.",
                            "  Manager: Professor Plum",
                            "SLA Elapsed Time: 9 hours"
                        ].join("<br>"),
                        at: new Date(2017, 2, 13, 10, 0)
                    },

                    {
                        type: TimelineChart.TYPE.POINT,
                        customClass: 'point-white',
                        label: [ 
                            "Event: Case owner sent email to employee.", 
                            "  Owner: Miss Scarlet",
                            "Event: Case closed by owner.", 
                            "  Owner: Miss Scarlet",
                            "Event: SLA clock paused.",
                            "SLA Elapsed Time: 9 hours 30 minutes"
                        ].join("<br>"),
                        at: new Date(2017, 2, 13, 10, 30),
                    }
                ]
            }
            ,
            {
                label: 'SLA Time Accrued',
                data: [
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-green',
                        from: new Date(2017, 2, 8, 11, 15),
                        to: new Date(2017, 2, 8, 13, 30)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-green',
                        from: new Date(2017, 2, 8, 15, 0),
                        to: new Date(2017, 2, 8, 16, 30)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-green',
                        from: new Date(2017, 2, 9, 9, 0),
                        to: new Date(2017, 2, 9, 9, 45)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-green',
                        from: new Date(2017, 2, 9, 12, 0),
                        to: new Date(2017, 2, 9, 12, 15)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-green',
                        from: new Date(2017, 2, 9, 12, 15),
                        to: new Date(2017, 2, 9, 12, 45)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-green',
                        from: new Date(2017, 2, 10, 8, 0),
                        to: new Date(2017, 2, 10, 8, 45)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-yellow',
                        from: new Date(2017, 2, 10, 8, 45),
                        to: new Date(2017, 2, 10, 9, 45)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-yellow',
                        from: new Date(2017, 2, 13, 8, 0),
                        to: new Date(2017, 2, 13, 10, 0)
                    },
                    {
                        label: null,
                        type: TimelineChart.TYPE.INTERVAL,
                        customClass: 'interval-orange',
                        from: new Date(2017, 2, 13, 10, 0),
                        to: new Date(2017, 2, 13, 10, 30)
                    }
                ]
            }
            ,
            {
                label: 'Work schedule "M-F 8am-5pm" for site "Phoenix, AZ"',
                data: [
                    {
                        label: 'Off-work hours',
                        type: TimelineChart.TYPE.INTERVAL,
                        from: new Date(2017, 2, 8, 18),
                        to: new Date(2017, 2, 9, 9)
                    }, 
                ]
            }
            ,
            {
                label: 'Work schedule "M-F 8am-5pm" for site "Houston, TX"',
                data: [
                    {
                        label: 'Off-work hours',
                        type: TimelineChart.TYPE.INTERVAL,
                        from: new Date(2017, 2, 9, 17),
                        to: new Date(2017, 2, 10, 8)
                    },
                    {
                        label: 'Off-work hours',
                        type: TimelineChart.TYPE.INTERVAL,
                        from: new Date(2017, 2, 10, 17),
                        to: new Date(2017, 2, 13, 8)
                    }
                ]
            }
            ,
            {
                label: 'Calendar "Half Days" for site "Houston, TX"',
                data: [
                    {
                        label: [ 
                            "Event: Half day",
                            "  Calendar: Time Off",
                            "  Site: Houston, TX"
                        ].join("<br>"),
                        label: 'Half Day Fridays!',
                        type: TimelineChart.TYPE.INTERVAL,
                        from: new Date(2017, 2, 10, 12),
                        to: new Date(2017, 2, 10, 17)
                    }
                ]
            }
        ];

        var _stl = 
        (function initializePrototypeTimeline() {

            // build a default label for intervals that don't have a label value set
            var index = 1;
            timelineData.forEach(function(g, gi) { 
                g.data.forEach(function(d, i) { 
                    var numberOfIds = !d.label ? 1 : (d.label.match(/Event:/g) || []).length || 1;
                    d.ids = Array.apply(null, Array(numberOfIds)).map(function (_, i) {return i+1+index;});
                    index += numberOfIds;
                    if (d.type === TimelineChart.TYPE.INTERVAL && !d.label)
                        d.label = formatDuration(d.to, d.from);
                });
            });

            var chartContainer = document.getElementsByTagName('body')[0].appendChild(document.createElement('div'));

            console.log('Sample Timeline Data: ', timelineData)
            var timeline = new TimelineChart(chartContainer, timelineData, {
                //enableLiveTimer: true, 
                tip: formatTipText
            }); //.onVizChange(e => console.log(e));



            function formatDate(date) {
                // We will only display fractional seconds to ms precision, because JS's date doesn't support any greater precision than that.
                //return moment(date).format('MMMM Do YYYY, h:mm:ss.SSS a');
                return moment(date).format('YYYY-MM-DD hh:mm:ss.SSS a');
            }

            var createLabelFromIntervalDuration = function(d){
                return formatDuration(d.to, d.from);
            };

            function formatLabelForTipHtml(label) {
                return (label || '').replace(/ /g, '&nbsp;').replace(/\\n/g, '<br>');
            };

            function formatDuration(later, earlier) {
                var msDiff = moment(later).diff(moment(earlier));
                var duration = moment.duration(msDiff);
                var parts = [
                    duration._data.years ? duration._data.years+' year(s)' : null,
                    duration._data.months ? duration._data.months+' month(s)' : null,
                    duration._data.days ? duration._data.days+' day(s)' : null,
                    duration._data.hours ? duration._data.hours+' hour(s)' : null,
                    duration._data.minutes ? duration._data.minutes+' minute(s)' : null,
                    duration._data.seconds ? duration._data.seconds+' second(s)' : null
                ].filter(function(x){return x!=null;});
                return parts.join(' ');
            };

            function formatTipText(d) {
                // if d.label is a fn, call it now.
                var lbl = typeof(d.label) == 'function' ? formatLabelForTipHtml(d.label(d)+'') : typeof(d.label)=='string' ? formatLabelForTipHtml(d.label) : '(no label)';
                // include "at" time for points or from/to time range for intervals with label
                var result = !!d.at ? 
                    lbl+'<br><br>Time: '+formatDate(d.at) : 
                    lbl+'<br><br>From: '+formatDate(d.from)+'<br>To: '+formatDate(d.to)+'<br>Duration: '+formatDuration(d.to, d.from);
                return result;
            };

            return timeline;
        })();

        // To iterate over all nodes in test data:  for (var i = 0; i < 55; i++){ setTimeout(curry(function(ind){ timeline.highlightNodeById(''+ind, true, 'chart-node-highlight'); }, i), 200*i);  }

        // function go() {
        //     [ new Date('Thu Mar 09 2017 06:50:46 GMT-0600'), new Date('Thu Mar 09 2017 15:40:31 GMT-0600') ]
        // }
    </script>

</body>

</html>
