<html>
<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.0.0/css/bootstrap-slider.min.css" rel="stylesheet" type="text/css"> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.0.0/bootstrap-slider.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
</head>
<body>
    <div style="margin: 2em auto; width: 700px;">
        <form class="form-inline">
            <div>
                Auto-update timers every 
                <input type="textbox" class="form-control" style="width: 60px" value="120" id="auto-update-interval-seconds"/> seconds for a total of 
                <input type="textbox" class="form-control" style="width: 60px" value="3" id="auto-update-duration-hours"/> hours.
                <button type="button" class="form-control btn btn-success" value="Start" id="auto-update-start">Start</button>
            </div>
            <div>
                <div> Time remaining until next update: <span id="time-remaining-until-update"></span> </div>
                <div> Number of updates remaining: <span id="updates-remaining"></span> </div>
                <div> Total Time remaining: <span id="total-time-remaining"></span> </div>
                <input type="button" class="form-control btn btn-secondary" value="Pause" id="auto-update-pause"/>
                <input type="button" class="form-control btn btn-secondary" value="Resume" id="auto-update-resume"/>
                <input type="button" class="form-control btn btn-danger" value="Stop and Reset" id="auto-update-reset"/>
            </div>

        </form>

        <!-- <label class="">
            <input id="ex7-enabled" type="checkbox" class=""/>  Enable Auto-Update of Timers
        </label>
        <label for="ex7">Interval between updates (in seconds):</label> <input id="ex7" type="text" data-slider-min="10" data-slider-max="600" data-slider-step="5" data-slider-value="120" data-slider-enabled="false"/> -->

        <input id="update-timer" type="button" class="btn btn-light" style="font-size: 2em; padding: 1em; width: 100%;" value="Update All Timers"/>
        <div style="font-size: 1.5em; margin: 1em 0; text-align: center;">
            <div id="pokeresult"></div>
            <br>
            <div id="timestamp"></div>
        </div>

    </div>
<script>

    function Timer2() {

        this.reset = function() {
            // A prefix of "ts" indicates it is a time span expressed in ms.
            this.tsIntervalSize = 120;
            this.tsEnds = 10800;

            this.tsNextInterval = 0
            this.tsElapsed = 0;
            this.tsRemaining = 0;
            this.lastTimeStarted = 0;
            this.tickFn = null;
            this.intervalElapsedFn = null;
            this.intervalId = null;
        }
        this.reset();

        this.start = function(intervalInSeconds, totalSeconds, tickFn, intervalElapsedFn)
        {
            try {
                if (isNaN(intervalInSeconds) || intervalInSeconds <= 0) throw "Interval is invalid.  It must be a positive integer.";
                if (isNaN(totalSeconds) || totalSeconds <= 0) throw "Total seconds is invalid.  It must be a positive integer.";
                //if (!tickFn) throw "Tick function must be provided.";
                if (!intervalElapsedFn) throw "Interval elapsed function must be provided.";
            }
            catch(e) {
                alert(e);
                return;
            }
            this.pause();

            this.tsIntervalSize = intervalInSeconds * 1000;
            this.tsEnds = totalSeconds * 1000;

            this.tsRemaining = this.tsEnds;
            this.tsElapsed = 0;
            this.tsNextInterval = this.tsIntervalSize;
            this.tickFn = tickFn;
            this.intervalElapsedFn = intervalElapsedFn;

            this.resume();
        }

        this.resume = function() {
            if (!(this.tsRemaining > 0)) return;
            this.lastTimeStarted = new Date().getTime();
            this.intervalId = setInterval(intervalHandler.bind(this), 500);
        }

        this.pause = function() {
            if (this.lastTimeStarted || 0 === 0) return;
            // one final update
            this.intervalHandler();
            // reset
            this.lastTimeStarted = 0;            
            clearInterval(this.intervalId);
        }

        function intervalHandler() {
            this.tsElapsed += new Date().getTime() - this.lastTimeStarted;
            this.tsRemaining = this.tsEnds - this.tsElapsed;
            if (this.tsElapsed > this.tsEnds) {
                clearInterval(this.intervalId);
            }
            if (this.tsElapsed > this.tsNextInterval) {
                this.tsNextInterval = this.tsIntervalSize + this.tsIntervalSize;
                this.intervalElapsedFn(this);
            }
            if (!!this.tickFn) this.tickFn(this);
        }
    }

    var timer = new Timer2();

    $('#auto-update-start').click(start);
    function start() {
        // validate inputs
        var intervalInSeconds = $('#auto-update-interval-seconds').val() * 1.0;
        var totalSeconds = $('#auto-update-duration-hours').val() * 3600.0;
        
        // try {
        //     if (isNaN(intervalInSeconds) || intervalInSeconds <= 0) throw "Interval is invalid.  It must be a positive integer.";
        //     if (isNaN(totalSeconds) || totalSeconds <= 0) throw "Total seconds is invalid.  It must be a positive integer.";
        // }
        // catch(e) {
        //     alert(e);
        //     return;
        // }

        timer.start(intervalInSeconds, totalSeconds, tick, function(){console.log('pokey')});

        //$('#auto-update-start').prop('disabled', true);
        $('#auto-update-reset').prop('disabled', false);
    }

    function tick() {
        var totalSecondsRemaining = timer.tsRemaining / 1000.0;
        var secondsRemainingUntilNextUpdate = (timer.tsNextInterval - timer.tsElapsed) / 1000.0;
        $('#time-remaining-until-update').text(secondsRemainingUntilNextUpdate + ' s');
        //$('#updates-remaining')
        $('#total-time-remaining').text(totalSecondsRemaining + ' s')
    }

    $('#auto-update-reset').click(reset);
    function reset(){
        timer.reset();
    // timer.pause();
    // timer = new Timer()();
        //$('#auto-update-reset').prop('disabled', true);
        $('#auto-update-start').prop('disabled', false);
    }

    $('#auto-update-pause').click(pause);
    function pause(){
        timer.pause();
    }

    $('#auto-update-resume').click(resume);
    function resume(){
        timer.resume();
    }

    $('update-timer').click(poke);
    function poke(){
        if (this.poking) return;
        this.poking = true;
        $('button').prop('disabled', true);
        $('#pokeresult').text('Please wait...');
        $('#timestamp').html('');
        var startTime = new Date().getTime();
        $.post('http://localhost/api/timers')
            .done(function(){ 
                $('#pokeresult').html('Timers updated successfully.'); 
            })
            .fail(function(jqXHR){ 
                $('#pokeresult').html('Timers NOT updated successfully. '+jqXHR.statusText+' ('+jqXHR.status+')'); 
            })
            .always(function(){
                var requestTime = new Date().getTime() - startTime;
                $('#timestamp').html('Duration: '+(requestTime/1000)+' seconds<br><br>'+new Date()); 
                $('button').prop('disabled', false);
                poke.poking = false;
            });
    }

    // $("#ex7").slider({ tooltip: 'always' });
    // $("#ex7-enabled").click(function() {
    //     if(this.checked) {
    //         // With JQuery
    //         $("#ex7").slider("enable");
    //     }
    //     else {
    //         // With JQuery
    //         $("#ex7").slider("disable");
    //     }
    // });

</script>
</body></html>
